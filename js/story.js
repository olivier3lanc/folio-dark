const story = {
    scenes: {
        'opening-credits-a': {
            layout: 'first'
        },
        'opening-credits-b': {
            layout: 'first'
        },
        'opening-credits-d': {
            layout: 'first'
        },
        'opening-credits-e': {
            layout: 'first'
        },
        'opening-credits-g': {
            layout: 'first'
        },
        'opening-credits-h': {
            layout: 'second'
        },
        'opening-credits-i': {
            layout: 'first'
        },
        'opening-credits-j': {
            layout: 'first'
        },
        'opening-credits-l': {
            layout: 'first'
        },
        'opening-credits-m': {
            layout: 'first'
        },
        'opening-credits-n': {
            layout: 'second'
        },
        'opening-credits-o': {
            layout: 'first'
        },
        'opening-credits-q': {
            layout: 'first'
        },
        'opening-credits-r': {
            layout: 'first'
        },
        'opening-credits-s': {
            layout: 'first'
        },
        'opening-credits-u': {
            layout: 'first'
        },
        'opening-credits-v': {
            layout: 'second'
        },
        'grottes-a': {
            layout: 'third'
        },
        'grottes-c': {
            layout: 'third'
        },
        'particles-a': {
            layout: 'third'
        },
        'particles-b': {
            layout: 'third'
        },
        'particles-c': {
            layout: 'third'
        },
        'particles-d': {
            layout: 'third'
        },
        'particles-e': {
            layout: 'third'
        },
        'machine-b': {
            layout: 'third'
        },
        'machine-c': {
            layout: 'third'
        },
        'foret-noa': {
            layout: 'third'
        },
        'route-a': {
            layout: 'third'
        },
        'route-c': {
            layout: 'third'
        },
        'blast': {
            layout: 'third'
        },
        'claudia-futur-b': {
            layout: 'third'
        },
        'adam-a': {
            layout: 'third'
        },
        'st-christophe-c': {
            layout: 'third'
        },
        'matter-c': {
            layout: 'third'
        },
        'matter-e': {
            layout: 'third'
        },
        'matter-f': {
            layout: 'third'
        },
        'matter-l': {
            layout: 'third'
        },
        'matter-g': {
            layout: 'third'
        },
        'matter-j': {
            layout: 'third'
        },
        'wormhole-a': {
            layout: 'third'
        },
        'wormhole-c': {
            layout: 'third'
        },
        'jonas-teen': {
            layout: 'third',
            data: {
                first: 'Jonas Kahnwald',
                second: 'Louis Hofmann'
            }
        },
        'martha-teen': {
            layout: 'third',
            data: {
                first: 'Martha Nielsen',
                second: 'Lisa Vicari'
            }
        },
        'bartosz': {
            layout: 'third',
            data: {
                first: 'Bartosz Tiedemann',
                second: 'Paul Lux'
            }
        },
        'magnus': {
            layout: 'third',
            data: {
                first: 'Magnus Nielson',
                second: 'Moritz Jahn'
            }
        },
        'franziska': {
            layout: 'third',
            data: {
                first: 'Franziska Doppler',
                second: 'Gina Stiebitz'
            }
        },
        'elisabeth': {
            layout: 'third',
            data: {
                first: 'Elisabeth Doppler',
                second: 'Carlotta von Falkenhayn'
            }
        },
        'mikkel': {
            layout: 'third',
            data: {
                first: 'Mikkel Nielsen',
                second: 'Daan Lennard Liebrenz'
            }
        },
        'michael': {
            layout: 'third',
            data: {
                first: 'Michael Kahnwald',
                second: 'Sebastian Rudolph'
            }
        },
        'hannah-child': {
            layout: 'third',
            data: {
                first: 'Hannah Kahnwald',
                second: 'Ella Lee'
            }
        },
        'hannah': {
            layout: 'third',
            data: {
                first: 'Hannah Kahnwald',
                second: 'Maja Schöne'
            }
        },
        'ulrich': {
            layout: 'third',
            data: {
                first: 'Ulrich Nielsen',
                second: 'Oliver Masucci'
            }
        },
        'ulrich-teen': {
            layout: 'third',
            data: {
                first: 'Ulrich Nielsen',
                second: 'Ludger Bökelmann'
            }
        },
        'katharina-teen': {
            layout: 'third',
            data: {
                first: 'Katharina Nielsen',
                second: 'Nele Trebs'
            }
        },
        'katharina': {
            layout: 'third',
            data: {
                first: 'Katharina Nielsen',
                second: 'Jördis Triebel'
            }
        },
        'charlotte-teen': {
            layout: 'third',
            data: {
                first: 'Charlotte Doppler',
                second: 'Stephanie Amarell'
            }
        },
        'charlotte': {
            layout: 'third',
            data: {
                first: 'Charlotte Doppler',
                second: 'Karoline Eichhorn'
            }
        },
        'aleksander-teen': {
            layout: 'third',
            data: {
                first: 'Aleksander Tiedemann',
                second: 'Béla Gabor Lenz'
            }
        },
        'aleksander': {
            layout: 'third',
            data: {
                first: 'Aleksander Tiedemann',
                second: 'Peter Benedict'
            }
        },
        'regina-teen': {
            layout: 'third',
            data: {
                first: 'Regina Tiedemann',
                second: 'Lydia Maria Makrides'
            }
        },
        'regina': {
            layout: 'third',
            data: {
                first: 'Regina Tiedemann',
                second: 'Deborah Kaufmann'
            }
        },
        'claudia-child': {
            layout: 'third',
            data: {
                first: 'Claudia Tiedemann',
                second: 'Gwendolyn Göbel'
            }
        },
        'claudia': {
            layout: 'third',
            data: {
                first: 'Claudia Tiedemann',
                second: 'Julika Jenkins'
            }
        },
        'claudia-old': {
            layout: 'third',
            data: {
                first: 'Claudia Tiedemann',
                second: 'Lisa Kreuzer'
            }
        },
        'helge-child': {
            layout: 'third',
            data: {
                first: 'Helge Doppler',
                second: 'Tom Philipp'
            }
        },
        'helge': {
            layout: 'third',
            data: {
                first: 'Helge Doppler',
                second: 'Peter Schneider'
            }
        },
        'helge-old': {
            layout: 'third',
            data: {
                first: 'Helge Doppler',
                second: 'Hermann Beyer'
            }
        },
        'tannhaus': {
            layout: 'third',
            data: {
                first: 'H.G. Tannhaus',
                second: 'Arnd Klawitter'
            }
        },
        'tannhaus-old': {
            layout: 'third',
            data: {
                first: 'H.G. Tannhaus',
                second: 'Christian Steyer'
            }
        },
        'bernd': {
            layout: 'third',
            data: {
                first: 'Bernd Doppler',
                second: 'Anatole Taubman'
            }
        },
        'bernd-old': {
            layout: 'third',
            data: {
                first: 'Bernd Doppler',
                second: 'Michael Mendl'
            }
        },
        'jana-teen': {
            layout: 'third',
            data: {
                first: 'Jana Nielsen',
                second: 'Rike Sindler'
            }
        },
        'jana': {
            layout: 'third',
            data: {
                first: 'Jana Nielsen',
                second: 'Anne Lebinsky'
            }
        },
        'jana-old': {
            layout: 'third',
            data: {
                first: 'Jana Nielsen',
                second: 'Tatja Seibt'
            }
        },
        'egon': {
            layout: 'third',
            data: {
                first: 'Egon Tiedemann',
                second: 'Sebastian Hülk'
            }
        },
        'egon-old': {
            layout: 'third',
            data: {
                first: 'Egon Tiedemann',
                second: 'Christian Pätzold'
            }
        },
        'tronte-child': {
            layout: 'third',
            data: {
                first: 'Tronte Nielsen',
                second: 'Joshio Marlon'
            }
        },
        'tronte': {
            layout: 'third',
            data: {
                first: 'Tronte Nielsen',
                second: 'Felix Kramer'
            }
        },
        'tronte-old': {
            layout: 'third',
            data: {
                first: 'Tronte Nielsen',
                second: 'Walter Kreye'
            }
        },
        'ines-teen': {
            layout: 'third',
            data: {
                first: 'Ines Kahnwald',
                second: 'Lena Urzendowsky'
            }
        },
        'ines': {
            layout: 'third',
            data: {
                first: 'Ines Kahnwald',
                second: 'Anne Ratte-Polle'
            }
        },
        'ines-old': {
            layout: 'third',
            data: {
                first: 'Ines Kahnwald',
                second: 'Angela Winkler'
            }
        },
        'peter': {
            layout: 'third',
            data: {
                first: 'Peter Doppler',
                second: 'Stephan Kampwirth'
            }
        },
        'doris': {
            layout: 'third',
            data: {
                first: 'Doris Tiedemann',
                second: 'Luise Heyer'
            }
        },
        'agnes': {
            layout: 'third',
            data: {
                first: 'Agnes Nielsen',
                second: 'Antje Traue'
            }
        },
        'greta': {
            layout: 'third',
            data: {
                first: 'Greta Doppler',
                second: 'Cordelia Wege'
            }
        },
        'jonas': {
            layout: 'third',
            data: {
                first: 'The Stranger',
                second: 'Andreas Pietschmann'
            }
        },
        'noah': {
            layout: 'third',
            data: {
                first: 'Noah',
                second: 'Mark Waschke'
            }
        },
        'about': {
            layout: 'fourth'
        }
    },
    quotes: [{
            first: 'Sic mundus',
            second: 'creatus est'
        },
        {
            first: 'The question is not where',
            second: 'but when'
        },
        {
            first: 'Der Anfang ist das Ende',
            second: 'Das Ende ist der Anfang'
        },
        {
            first: 'Alles ist',
            second: 'miteinander verbunden'
        },
        {
            first: 'The beginning is the end',
            second: 'The end is the beginning'
        },
        {
            first: 'Everything',
            second: 'is connected'
        },
        {
            first: 'Tick tack',
            second: 'Tick tack'
        },
        {
            first: 'As you sow',
            second: 'so you shall reap'
        },
        {
            first: 'Alles ist',
            second: 'jetzt'
        },
        {
            first: 'Life and Death',
            second: 'Leben und Tod'
        },
        {
            first: 'Light and Shadow',
            second: 'Licht und Schatten'
        },
        {
            first: 'An Endless Cycle',
            second: 'Ein unendlicher Kreis'
        },
        {
            first: 'In Between Time',
            second: 'Zwischen der Zeit'
        },
        {
            first: 'Endings and Beginnings',
            second: 'Enden und Anfänge'
        }
    ],
    getRandomQuote: function() {
        const random_float = Math.random();
        const amount_of_quotes = Object.keys(story.quotes).length;
        const random_index = Math.ceil(amount_of_quotes * random_float) - 1;
        const random_quote = story.quotes[random_index];
        return random_quote;
    },
    getNextSceneId: function(current_scene_id) {
        const scenes_id = Object.keys(story.scenes);
        const next_index = scenes_id.indexOf(current_scene_id) + 1;
        const next_scene_id = scenes_id[next_index];
        return next_scene_id;
    },
    getPreviousSceneId: function(current_scene_id) {
        const scenes_id = Object.keys(story.scenes);
        const previous_index = scenes_id.indexOf(current_scene_id) - 1;
        const previous_scene_id = scenes_id[previous_index];
        return previous_scene_id;
    },
    elements: {
        loader: window.parent.document.querySelector('#app_loader'),
        main: document.querySelector('main'),
        progress: document.getElementById('app_progress')
    },
    layouts: {
        first: function(data) {
            let markup = story.includes.scroll_frames('json/'+data.scene_current_id+'.json');
            markup += story.includes.dark_split_text_scroll(data.scene_data);
            markup += story.includes.navigation_alt(data.scene_current_id);
            markup += story.includes.onboarding_scroll();
            return markup;
        },
        second: function(data) {
            let markup = story.includes.scroll_frames('json/'+data.scene_current_id+'.json');
            markup += story.includes.dark_title();
            markup += story.includes.navigation_alt(data.scene_current_id);
            markup += story.includes.onboarding_scroll();
            return markup;
        },
        third: function(data) {
            let markup = story.includes.css_video_frames(data.scene_current_id);
            markup += story.includes.dark_split_text(data.scene_data);
            markup += story.includes.navigation(data.scene_current_id);
            markup += story.includes.onboarding();
            return markup;
        },
        fourth: function(data) {
            let markup = story.includes.css_video_frames('matter-j');
            var xhr = new XMLHttpRequest();
            xhr.onload = function() {
                story.elements.main.innerHTML = markup + this.responseXML.body.innerHTML;
            }
            xhr.open("GET", "about.html");
            xhr.responseType = "document";
            xhr.send();
        }
    },
    includes: {
        navigation: function(current_scene_id) {
            return `
                <nav class="c-position m-fixed m-bottom-md m-left-0 c-grid m-center m-nowrap u-w-100" m-bottom-25="sm" role="navigation">
                    <a href="scene.html?scene=${story.getPreviousSceneId(current_scene_id)}" class="c-btn m-thin m-transparent c-effect m-span-180-core-x m-span-180-rotate u-lh-0 u-fs-lg" u-p-sm="sm" u-fs-md="sm" title="Previous scene">
                        <span><span class="c-shape m-chevron-left"></span></span>
                    </a>
                    <a href="scene.html?scene=${story.getNextSceneId(current_scene_id)}" class="c-btn m-thin c-effect m-span-180-core-x m-span-180-rotate u-lh-0 u-fs-lg" u-p-sm="sm" u-fs-md="sm" title="Next scene">
                        <span><span class="c-shape m-chevron-right"></span></span>
                    </a>
                </nav>
            `;
        },
        navigation_alt: function(current_scene_id) {
            return `
                <nav class="c-position m-relative c-grid m-center m-nowrap u-w-100 u-bg-gradient-vertical u-pb-xxl" u-pb-lg="sm" role="navigation">
                    <a href="scene.html?scene=${story.getPreviousSceneId(current_scene_id)}" class="c-btn m-thin m-transparent c-effect m-span-180-core-x m-span-180-rotate u-lh-0 u-fs-lg" u-p-sm="sm" u-fs-md="sm" title="Previous scene">
                        <span><span class="c-shape m-chevron-left"></span></span>
                    </a>
                    <a href="scene.html?scene=${story.getNextSceneId(current_scene_id)}" class="c-btn m-thin c-effect m-span-180-core-x m-span-180-rotate u-lh-0 u-fs-lg" u-p-sm="sm" u-fs-md="sm" title="Next scene">
                        <span><span class="c-shape m-chevron-right"></span></span>
                    </a>
                </nav>
            `;
        },
        onboarding_scroll: function() {
            return `
                <div class="c-position m-fixed m-middle-center m-anchor-top-center c-grid m-nowrap m-center u-ta-center u-mt-xl"
                    scroll-btween="app_scene_onboarding_mouse"
                    scroll-btween-detector="app_scene_detector" 
                    data-opacity="|0:1 to 15:0 to 100:0|"
                    u-mt-md="sm">
                    <div class="c-spacing m-w-6 u-p-xxs">
                        <span class="c-shape m-mouse u-fs-xl" u-fs-lg="sm"></span> 
                        <p class="u-fs-xs u-m-none u-ff-lead u-c-primary-max u-lh-1">Scroll down</p>
                    </div>
                    <div class="c-spacing m-w-6 u-p-xxs u-orient-portrait" u-none="md,xl">
                        <span class="c-shape m-orientation-landscape u-fs-xl" u-fs-lg="sm"></span> 
                        <p class="u-fs-xs u-m-none u-ff-lead u-c-primary-max u-lh-1">Landscape orientation recommended</p>
                    </div>
                </div>
            `
        },
        onboarding: function() {
            return `
                <div class="c-position m-fixed m-middle-center m-anchor-top-center u-ta-center u-mt-xl" u-mt-md="sm">
                    <div class="u-p-xxs u-orient-portrait" u-none="md,xl">
                        <span class="c-shape m-orientation-landscape u-fs-xl" u-fs-lg="sm"></span><br>
                        <p class="u-fs-xs u-m-none u-ff-lead u-c-primary-max u-lh-1">Landscape orientation recommended</p>
                    </div>
                </div>
            `
        },
        scroll_frames: function(jsonURL) {
            return `
                <article class="u-h-100vh">
                    <figure class="c-position m-fixed m-top-0 u-w-100 u-h-100vh u-brep-no-repeat u-bpos-center u-m-none u-p-none"
                        style="will-change: background-image, background-size;" 
                        scroll-frames="scene"
                        scroll-frames-detector="app_scene_detector" 
                        data-json="${jsonURL}">
                    </figure>
                    <!-- <div class="c-position m-fixed m-top-0 u-w-100 u-h-100vh u-bc-primary-rev u-pe-none u-faded"></div> -->
                    <div class="c-position m-fixed m-top-0 u-w-100 u-h-100vh u-pe-none u-faded u-bg-stripes" u-none="sm"></div>
                </article>
                <div id="app_scene_detector"></div>
                <div id="app_screen_height" class="u-h-100vh"></div>
            `
        },
        dark_title: function() {
            return `
                <h1 id="app_dark_title"
                    class="c-position m-fixed m-middle-center m-anchor-middle-center c-grid m-nowrap u-m-none u-ff-lead u-fw-100 u-fs-xl u-tt-uppercase u-c-primary-max">
                    <span   scroll-btween="letter_1" 
                            scroll-btween-detector="app_scene_detector"
                            data-margin="0em |0.1 to 1|em"
                            data-opacity="|0:0 to 60:1 to 100:1|">D</span>
                    <span   scroll-btween="letter_2" 
                            scroll-btween-detector="app_scene_detector"
                            data-margin="0em |0.1 to 1|em"
                            data-opacity="|0:0 to 60:1 to 100:1|">A</span>
                    <span   scroll-btween="letter_3" 
                            scroll-btween-detector="app_scene_detector"
                            data-margin="0em |0.1 to 1|em"
                            data-opacity="|0:0 to 60:1 to 100:1|"
                            style="perspective: 1em;">
                        <span class="u-block" 
                            scroll-btween="letter_3_1"
                            scroll-btween-detector="app_scene_detector"
                            data-transform="rotateY(|0:0 to 50:0 to 100:180|deg)">R</span>
                    </span>
                    <span   scroll-btween="letter_4" 
                            scroll-btween-detector="app_scene_detector"
                            data-margin="0em |0.1 to 1|em"
                            data-opacity="|0:0 to 60:1 to 100:1|">K</span>
                </h1>
            `
        },
        dark_split_text_scroll: function(data) {
            let random_quote = story.getRandomQuote();
            if (typeof data == 'object') {
                if (data.first !== undefined) {
                    random_quote.first = data.first;
                }
                if (data.second !== undefined) {
                    random_quote.second = data.second;
                }
            }
            return `
                <h1 id="app_dark_text_split"
                    class="c-spacing m-w-10 c-position m-fixed m-middle-center m-anchor-middle-center u-m-none u-ff-lead-alt u-fw-100 u-fs-md u-tt-uppercase u-ta-center u-lh-smooth"
                    u-fs-xs="sm"
                    u-fs-sm="md">
                        <span   class="u-c-primary-max u-ml-xxs u-mr-xxs u-ws-nowrap"
                                scroll-btween="letter_spacing_1"
                                scroll-btween-detector="app_scene_detector"
                                data-letter-spacing="|0.2 to 0.5|em"
                                data-opacity="|0:0.6 to 30:1 to 100:1|">${random_quote.first}</span> 
                        <span   class="u-c-primary u-mr-xxs u-ml-xxs u-ws-nowrap"
                                scroll-btween="letter_spacing_2"
                                scroll-btween-detector="app_scene_detector"
                                data-letter-spacing="|0.2 to 0.5|em"
                                data-opacity="|0:0.6 to 30:1 to 100:1|">${random_quote.second}</span>
                </h1>
            `
        },
        dark_split_text: function(data) {
            let random_quote = story.getRandomQuote();
            if (typeof data == 'object') {
                if (data.first !== undefined) {
                    random_quote.first = data.first;
                }
                if (data.second !== undefined) {
                    random_quote.second = data.second;
                }
            }
            return `
                <h1 id="app_dark_text_split"
                    class="c-spacing m-w-10 c-position m-fixed m-middle-center m-anchor-middle-center u-m-none u-ff-lead-alt u-fw-100 u-fs-md u-tt-uppercase u-ta-center u-lh-smooth u-lsp-xlarge"
                    u-fs-xs="sm"
                    u-fs-sm="md">
                    <span class="u-c-primary-max u-ml-xxs u-mr-xxs u-ws-nowrap">${random_quote.first}</span> 
                    <span class="u-c-primary u-mr-xxs u-ml-xxs u-ws-nowrap">${random_quote.second}</span>
                </h1>
            `
        },
        css_video_frames: function(id) {
            return `
                <link rel="stylesheet" href="css/${id}.css">
                <div class="c-grid c-position m-fixed m-middle-center m-anchor-middle-center">
                    <div id="${id}" class="u-minh-100vh u-minw-100vw"></div>
                </div>
                <!--<div class="c-position m-fixed m-top-0 u-w-100 u-h-100vh u-bc-primary-rev u-pe-none u-faded"></div>-->
                <div class="c-position m-fixed m-top-0 u-w-100 u-h-100vh u-pe-none u-faded u-bg-stripes" u-none="sm"></div>
            `
        }
    },
    update: function() {
        let gets = new URLSearchParams(location.search);
        const scene_current_id = gets.get('scene');
        console.log(scene_current_id);
        // Build the scene content
        if (scene_current_id !== null) {
            const scene = {
                scene_current_id: scene_current_id,
                scene_layout: story.scenes[scene_current_id].layout,
                scene_data: story.scenes[scene_current_id].data
            };
            if (typeof scene == 'object') {
                // Insert HTML
                const markup = this.layouts[scene.scene_layout](scene);
                this.elements.main.innerHTML = markup;
                // Progress bar
                const scenes_ids_list = Object.keys(story.scenes);
                const max_index = scenes_ids_list.length - 1;
                const current_scene_index = scenes_ids_list.indexOf(scene_current_id);
                const progress_percentage = 100 * current_scene_index / max_index;
                // Non-linear progress
                const position_33 = 19.54;
                const position_66 = 47.13;
                let progress_value = 0;
                if (progress_percentage < position_33) {
                    progress_value = progress_percentage * 33 / position_33;
                }
                if (progress_percentage >= position_33 && progress_percentage < position_66) {
                    progress_value = 33 + (progress_percentage - position_33) * 33 / (position_66 - position_33);
                    // 19.54 -> 33
                    // 47.13 -> 66
                }
                if (progress_percentage >= position_66) {
                    progress_value = 66 + (progress_percentage - position_66) * 66 / (100 - position_66);
                }
                if (progress_value > 100) {
                    progress_value = 100;
                }
                story.elements.progress.style.width = progress_value+'%';
            }
        }
        if (this.elements.loader !== null) {
            // Scene loaded
            window.addEventListener('load', function() {
                // Reveal scene once loaded
                story.elements.loader.classList.add('u-transparent');
                // Remove all click effect nodes
                window.parent.document.querySelectorAll('.effect-click').forEach(function(el) {
                    el.remove();
                });
            });
        }
        // Manage smooth transitions between scenes
        document.querySelectorAll('a[href^="scene.html"]').forEach(function(el) {
            el.addEventListener('click', function(e) {
                e.preventDefault();
                story.elements.loader.classList.remove('u-transparent');
                const target_url = e.target.getAttribute('href');
                setTimeout(function() {
                    location.href = target_url;
                }, 500);
            });
        });
    }
}
story.update();
